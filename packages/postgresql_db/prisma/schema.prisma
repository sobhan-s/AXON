generator client {
  provider     = "prisma-client-js"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique
  password                String
  username                String
  organizationId          Int?
  avatarUrl               String?
  isEmailVerified         Boolean                  @default(false)
  emailVerifiedAt         DateTime?
  resetPasswordToken      String?
  resetPasswordExpiry     DateTime?
  isActive                Boolean                  @default(true)
  lastLoginAt             DateTime?
  lastLoginIp             String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  
  refreshTokens           RefreshToken[]
  activityLogs            ActivityLog[]
  requestedApprovals      Approval[]               @relation("ApprovalRequester")
  reviewedApprovals       Approval[]               @relation("ApprovalReviewer")
  emailVerificationTokens EmailVerificationToken[]
  assignedModules         Module[]                 @relation("ModuleAssignee")
  createdModules          Module[]                 @relation("ModuleCreator")
  assignedOrganizations   Organization[]           @relation("OrgAssignee")
  createdOrganizations    Organization[]           @relation("OrgCreator")
  passwordResetTokens     PasswordResetToken[]
  projectTeamMembers      ProjectTeamMember[]
  assignedProjects        Project[]                @relation("ProjectAssignee")
  createdProjects         Project[]                @relation("ProjectCreator")
  assignedTasks           Task[]                   @relation("TaskAssignee")
  createdTasks            Task[]                   @relation("TaskCreator")
  timeLogs                TimeLog[]
  organization            Organization?            @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([organizationId])
  @@index([isActive])
  @@map("users")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Organization {
  id           Int           @id @default(autoincrement())
  name         String
  slug         String        @unique
  description  String?
  createdBy    Int
  assignedTo   Int?
  storageLimit BigInt        @default(10737418240)
  storageUsed  BigInt        @default(0)
  status       UserStatus    @default(ACTIVE)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  activityLogs ActivityLog[]
  assignee     User?         @relation("OrgAssignee", fields: [assignedTo], references: [id])
  creator      User          @relation("OrgCreator", fields: [createdBy], references: [id])
  projects     Project[]
  users        User[]

  @@index([slug])
  @@index([createdBy])
  @@index([status])
  @@map("organizations")
}

model Project {
  id             Int                 @id @default(autoincrement())
  name           String
  slug           String
  description    String?
  createdBy      Int
  assignedTo     Int?
  organizationId Int
  status         ProjectStatus       @default(ACTIVE)
  isArchived     Boolean             @default(false)
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  modules        Module[]
  teamMembers    ProjectTeamMember[]
  assignee       User?               @relation("ProjectAssignee", fields: [assignedTo], references: [id])
  creator        User                @relation("ProjectCreator", fields: [createdBy], references: [id])
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([createdBy])
  @@index([status])
  @@map("projects")
}

model ProjectTeamMember {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    Int
  addedBy   Int
  roleId    Int
  addedAt   DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_team_members")
}

model Module {
  id          Int           @id @default(autoincrement())
  name        String
  slug        String
  description String?
  projectId   Int
  createdBy   Int
  assignedTo  Int?
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  assignee    User?         @relation("ModuleAssignee", fields: [assignedTo], references: [id])
  creator     User          @relation("ModuleCreator", fields: [createdBy], references: [id])
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([createdBy])
  @@index([assignedTo])
  @@map("modules")
}

model Task {
  id             Int          @id @default(autoincrement())
  title          String
  description    String?
  moduleId       Int
  taskType       TaskType     @default(MANUAL)
  createdById    Int
  assignedToId   Int?
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  estimatedHours Decimal?     @db.Decimal(5, 2)
  dueDate        DateTime?
  assetId        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  completedAt    DateTime?
  approvals      Approval[]
  assignedTo     User?        @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy      User         @relation("TaskCreator", fields: [createdById], references: [id])
  module         Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  timeLogs       TimeLog[]

  @@index([moduleId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([taskType])
  @@index([assetId])
  @@map("tasks")
}

model TimeLog {
  id          Int      @id @default(autoincrement())
  taskId      Int
  userId      Int
  hours       Decimal  @db.Decimal(5, 2)
  description String?
  loggedAt    DateTime @default(now())
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@index([loggedAt])
  @@map("time_logs")
}

model Approval {
  id            Int            @id @default(autoincrement())
  taskId        Int
  assetId       String
  requestedById Int
  reviewedById  Int?
  status        ApprovalStatus @default(PENDING)
  comments      String?
  requestedAt   DateTime       @default(now())
  reviewedAt    DateTime?
  requestedBy   User           @relation("ApprovalRequester", fields: [requestedById], references: [id])
  reviewedBy    User?          @relation("ApprovalReviewer", fields: [reviewedById], references: [id])
  task          Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([assetId])
  @@index([requestedById])
  @@index([reviewedById])
  @@index([status])
  @@map("approvals")
}

model ActivityLog {
  id             Int            @id @default(autoincrement())
  userId         Int?
  organizationId Int?
  action         ActivityAction
  entityType     String?
  entityId       String?
  details        Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime       @default(now())
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

model Role {
  id                 Int                 @id @default(autoincrement())
  name               String              @unique
  level              Int
  description        String?
  createdAt          DateTime            @default(now())
  projectTeamMembers ProjectTeamMember[]
  permissions        RolePermission[]

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  FAILED
  APPROVED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskType {
  ASSET_BASED
  MANUAL
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
  ON_HOLD
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ActivityAction {
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTERED
  ORG_CREATED
  ORG_UPDATED
  PROJECT_CREATED
  PROJECT_UPDATED
  MODULE_CREATED
  TASK_CREATED
  TASK_ASSIGNED
  TASK_STATUS_CHANGED
  ASSET_UPLOADED
  ASSET_APPROVED
  ASSET_REJECTED
  ASSET_FINALIZED
  USER_CREATED
  USER_UPDATED
  USER_ROLE_CHANGED
}
